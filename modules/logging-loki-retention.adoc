// Module included in the following assemblies:
//
// * observability/logging/log_storage/cluster-logging-loki.adoc
// * configuring/configuring-the-log-store.adoc

:_mod-docs-content-type: PROCEDURE
[id="logging-loki-retention_{context}"]
= Enabling stream-based retention with Loki

You can configure retention policies based on log streams. You can set retention rules globally, per-tenant, or both. If you configure both, tenant rules apply before global rules.

include::snippets/logging-retention-period-snip.adoc[]

[NOTE]
====
* Although logging version 5.9 and later supports schema `v12`, schema `v13` is recommended for future compatibility.

* For cost-effective log pruning, configure retention policies directly on the object storage provider. Use the lifecycle management features of the storage provider to ensure automatic deletion of old logs. This also avoids extra processing from Loki and delete requests to S3.
+
If the object storage does not support lifecycle policies, you must configure LokiStack to enforce retention internally. The supported retention period is up to 30 days.
====

.Prerequisites 

* You have administrator permissions.
* You have installed the {loki-op}.
* You have installed the {oc-first}.

.Procedure

. To enable stream-based retention, create a `LokiStack` CR and save it as a YAML file. In the following example, it is called `lokistack.yaml`.
+
--
.Example global stream-based retention for S3
[source,yaml]
----
apiVersion: loki.grafana.com/v1
kind: LokiStack
metadata:
  name: logging-loki
  namespace: openshift-logging
spec:
  limits:
   global: # <1>
      retention: # <2>
        days: 20
        streams:
        - days: 4
          priority: 1
          selector: '{kubernetes_namespace_name=~"test.+"}' # <3>
        - days: 1
          priority: 1
          selector: '{log_type="infrastructure"}'
  managementState: Managed
  replicationFactor: 1
  size: 1x.small
  storage:
    schemas:
    - effectiveDate: "2020-10-11"
      version: v13
    secret:
      name: logging-loki-s3
      type: s3
  storageClassName: gp3-csi
  tenants:
    mode: openshift-logging
----
<1> Set the retention policy for all log streams. This policy does not impact the retention period for stored logs in object storage.
<2> Enable retention in the cluster by adding the `retention` block to the CR.
<3> Specify the link:https://grafana.com/docs/loki/latest/logql/query_examples/#query-examples[LogQL query] to match log streams to the retention rule.
--
+
.Example per-tenant stream-based retention for S3
[source,yaml]
----
apiVersion: loki.grafana.com/v1
kind: LokiStack
metadata:
  name: logging-loki
  namespace: openshift-logging
spec:
  limits:
    global:
      retention:
        days: 20
    tenants: # <1>
      application:
        retention:
          days: 1
          streams:
            - days: 4
              selector: '{kubernetes_namespace_name=~"test.+"}' # <2>
      infrastructure:
        retention:
          days: 5
          streams:
            - days: 1
              selector: '{kubernetes_namespace_name=~"openshift-cluster.+"}'
  managementState: Managed
  replicationFactor: 1
  size: 1x.small
  storage:
    schemas:
    - effectiveDate: "2020-10-11"
      version: v13
    secret:
      name: logging-loki-s3
      type: s3
  storageClassName: gp3-csi
  tenants:
    mode: openshift-logging
----
<1> Set the retention policy per-tenant. Valid tenant types are `application`, `audit`, and `infrastructure`.
<2> Specify the link:https://grafana.com/docs/loki/latest/logql/query_examples/#query-examples[LogQL query] to match log streams to the retention rule.

. Apply the `LokiStack` CR:
+
[source,terminal]
----
$ oc apply -f lokistack.yaml
----
